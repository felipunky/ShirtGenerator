<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="./wasm-arrays.min.js"></script>
</head>

<body>

    <!-- Create the canvas that the C++ code will draw into -->
    <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    <canvas id="canvasDrawImag" oncontextmenu="event.preventDefault()"></canvas>
    <div>
        <!-- <input type="file" id="objPicker" accept=".obj"> -->
    </div>
    <script type='text/javascript'>
        var canv = document.getElementById('canvas');
        var Module = 
        {
            canvas: canv
        };
        let previewCanvasContext;
        let img;
        let cv;
        let clicked = 0;
        let sizeData = [0, 0, 0];
        let downloadImage = 0;
        window.onload = function()
        {
            var cvDrawImg = document.getElementById("canvasDrawImag");
            //cvDrawImg.id = "canvasDrawImag";
            cvDrawImg.width = 600;
            cvDrawImg.height = 400;
            cvDrawImg.style.left = "608px";
            cvDrawImg.style.top = "8px";
            cvDrawImg.style.position = "absolute";
            const loadImage = src => 
            {
                img = new Image()
                img.addEventListener("load", () => 
                {
                    cv = document.createElement("canvas");
                    cv.id = "previewCanvas";
                    cv.height = img.height;
                    cv.width = img.width;

                    sizeData = [cv.width, cv.height, clicked];

                    previewCanvasContext = cv.getContext("2d");
                    previewCanvasContext.drawImage(img, 0, 0);

                    console.log("Passing image data to WASM");
                })
                img.src = src
            }
            // Default image
            loadImage("Assets/Textures/WatchMen.jpeg");

            function passToWASM()
            {
                const imageData = previewCanvasContext.getImageData(0, 0, cv.width, cv.height).data;
                console.log("Image data size: " + imageData.length);
                console.log("Width: " +  cv.width);
                console.log("Height: " + cv.height);
                
                console.log("Width 1: " + sizeData[0]);
                console.log("Height 2: " + sizeData[1]);
                console.log("Clicked: " + sizeData[2]);
                
                //const sizeData = [cv.width, cv.height, clicked, imageData.length];
                ccallArrays("passSize", null, ["array"], [sizeData], {heapIn: "HEAPU16"});
                ccallArrays("load", null, ["array"], [imageData], {heapIn: "HEAPU8"})
                // // Pass the imageData to the C++ code
                // ccallArrays("load", null, ["array"], [imageData], {heapIn: "HEAPU8"})
            } 

            // File input
            const fileInput = document.getElementById("fileInput");
            fileInput.addEventListener("change", () => {
                loadImage(URL.createObjectURL(event.target.files[0]))
                passToWASM();
            })

            convert.addEventListener("click", () => 
            {
                if (!clicked)
                {
                    clicked = 1;
                }
                else
                {
                    clicked = 0;
                }
                passToWASM();
            });

            var drawArray = function(arr, width, height) 
            {
                // var cvDrawImg = document.createElement("canvas");
                var render = cvDrawImg.getContext("2d");
                // cvDrawImg.id = "canvasDrawImag";
                // cvDrawImg.width = 600;
                // cvDrawImg.height = 400;
                // cvDrawImg.style.left = "600px";
                // cvDrawImg.style.top = "0px";
                // cvDrawImg.style.position = "absolute";
                var ctx = cvDrawImg.getContext('2d');
                
                // create the imageData object, you'll need the width and height of your image
                var dataImage = ctx.createImageData(width, height);
                // browsers supporting TypedArrays
                if (dataImage.data.set) {
                    dataImage.data.set(arr);
                } else {
                    // IE9
                    arr.forEach(function(val, i) {
                    dataImage.data[i] = val;
                    });
                }
                ctx.putImageData(dataImage, 0, 0);
            };

            download.addEventListener("click", () =>{
                // const obj2gltf = require("obj2gltf");
                // const fs = require("fs");
                // obj2gltf("Assets/t-shirt-lp/source/Shirt.obj").then(function (gltf) {
                //     const data = Buffer.from(JSON.stringify(gltf));
                //     console.log(data);
                //     //fs.writeFileSync("model.gltf", data);
                if (downloadImage == 0)
                {
                    downloadImage = 1;
                }
                else
                {
                    downloadImage = 0;
                }
                let downloadImageArray = [downloadImage, 2, 3];
                // const res = ccallArrays("doubleValues", "array", ["array"], [[1,2,3,4,5]], {heapIn: "HEAP8", heapOut: "HEAP8", returnArraySize: 5})
                // console.log(res) // [2,4,6,8,10]
                const res = ccallArrays("doubleValues", "array", ["array"], [downloadImageArray], 
                                        {heapIn: "HEAPU8", heapOut: "HEAPU8", returnArraySize: 4 * 600 * 400});
                console.log(res);
                drawArray(res, 600, 400);
                // var iData = new ImageData(res, 600, 400);
                // var ctx = canv.getContext("2d");
                // ctx.putImageData(iData, 0, 0);
            });

        }
    </script>
    
    <!-- Call the javascript glue code (index.js) as generated by Emscripten -->
    <script src="index.js"></script>
    
    <!-- Allow the javascript to call C++ functions -->
    <script type='text/javascript'>
        //canv.addEventListener('click',    _toggle_background_color, false);
        //canv.addEventListener('touchend', _toggle_background_color, false);
    </script>

</body>
<input id="fileInput" type="file" accept="image/*" value="./image.png">
<button id="convert">Convert</button>
<button id="download">download</button>
</html>
