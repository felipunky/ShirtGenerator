<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="./wasm-arrays.min.js"></script>
</head>

<body>

    <!-- Create the canvas that the C++ code will draw into -->
    <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>

    <div>
        <!-- <input type="file" id="objPicker" accept=".obj"> -->
    </div>
    <script type='text/javascript'>
        var canv = document.getElementById('canvas');
        var Module = 
        {
            canvas: canv
        };
        let previewCanvasContext;
        let img;
        let cv;
        let clicked = 0;
        let sizeData = [0, 0, 0];
        window.onload = function()
        {
            const loadImage = src => 
            {

                //Module.ccall("clearContexts", null, null, null)

                img = new Image()
                img.addEventListener("load", () => {

                    cv = document.createElement("canvas")
                    cv.id = "previewCanvas"
                    cv.height = img.height
                    cv.width = img.width

                    sizeData = [cv.width, cv.height, clicked]

                    previewCanvasContext = cv.getContext("2d")
                    previewCanvasContext.drawImage(img, 0, 0)

                    console.log("Passing image data to WASM");
                    // Get imageData from the image
                    //const imageData = previewCanvasContext.getImageData(0, 0, img.width, img.height).data

                    // Pass the imageData to the C++ code
                    //ccallArrays("load", null, ["array"], [imageData], {heapIn: "HEAPU8"})

                    //createCanvas("textureLoad", 0, img.width, img.height)
                    //createCanvas("edgeDetect", 1, img.width, img.height)
                })
                img.src = src
            }
            // Default image
            loadImage("Assets/Textures/WatchMen.jpeg");

            function passToWASM()
            {
                const imageData = previewCanvasContext.getImageData(0, 0, cv.width, cv.height).data;
                console.log("Image data size: " + imageData.length);
                console.log("Width: " +  cv.width);
                console.log("Height: " + cv.height);
                
                console.log("Width 1: " + sizeData[0]);
                console.log("Height 2: " + sizeData[1]);
                console.log("Clicked: " + sizeData[2]);
                
                //const sizeData = [cv.width, cv.height, clicked, imageData.length];
                ccallArrays("passSize", null, ["array"], [sizeData], {heapIn: "HEAPU16"});
                ccallArrays("load", null, ["array"], [imageData], {heapIn: "HEAPU8"})
                // // Pass the imageData to the C++ code
                // ccallArrays("load", null, ["array"], [imageData], {heapIn: "HEAPU8"})
            } 

            // File input
            const fileInput = document.getElementById("fileInput");
            fileInput.addEventListener("change", () => {
                loadImage(URL.createObjectURL(event.target.files[0]))
                passToWASM();
            })

            convert.addEventListener("click", () => {
                if (!clicked)
                {
                    clicked = 1;
                }
                else
                {
                    clicked = 0;
                }
                passToWASM();
            })

            download.addEventListener("change", () =>{
                // const obj2gltf = require("obj2gltf");
                // const fs = require("fs");
                // obj2gltf("Assets/t-shirt-lp/source/Shirt.obj").then(function (gltf) {
                //     const data = Buffer.from(JSON.stringify(gltf));
                //     console.log(data);
                //     //fs.writeFileSync("model.gltf", data);
                console.log("Download file");
            });

        }
    </script>
    
    <!-- Call the javascript glue code (index.js) as generated by Emscripten -->
    <script src="index.js"></script>
    
    <!-- Allow the javascript to call C++ functions -->
    <script type='text/javascript'>
        //canv.addEventListener('click',    _toggle_background_color, false);
        //canv.addEventListener('touchend', _toggle_background_color, false);
    </script>

</body>
<input id="fileInput" type="file" accept="image/*" value="./image.png">
<button id="convert">Convert</button>
<button id="download">download</button>
</html>
